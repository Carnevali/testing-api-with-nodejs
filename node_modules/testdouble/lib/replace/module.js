"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var lodash_1 = require("../wrap/lodash");
var path_1 = require("path");
var quibble = require("quibble");
var jest_module_1 = require("./jest-module");
var imitate_1 = require("../imitate");
quibble.ignoreCallsFromThisFile();
function default_1(path, stub) {
    if (typeof jest === 'object')
        return jest_module_1.default.apply(void 0, arguments);
    if (arguments.length > 1) {
        return quibble(path, stub);
    }
    var realThing = requireAt(path);
    var fakeThing = imitate_1.default(realThing, path + ": " + nameFor(realThing));
    quibble(path, fakeThing);
    return fakeThing;
}
exports.default = default_1;
var nameFor = function (realThing) {
    if (!lodash_1.default.isFunction(realThing))
        return '';
    return realThing.name ? realThing.name : '(anonymous function)';
};
var requireAt = function (modulePath) {
    try {
        // 1. Try just following quibble's inferred path
        return require(quibble.absolutify(modulePath));
    }
    catch (e) {
        // 2. Try including npm packages
        return require(require.resolve(modulePath, { paths: [
                path_1.default.join(process.cwd(), 'node_modules')
            ] }));
    }
};
